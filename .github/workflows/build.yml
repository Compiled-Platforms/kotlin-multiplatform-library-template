name: Build & Test

# CI behavior controlled by project.yml:
# - ci.enabled_branches: Controls which branches run CI
#   - [main] = only main branch
#   - [main, develop] = main and develop branches
#   - all = every branch
#   - false = disabled

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  # Load configuration from project.yml
  config:
    runs-on: ubuntu-latest
    outputs:
      ci-enabled: ${{ steps.load.outputs.ci-enabled }}
      current-branch: ${{ steps.load.outputs.current-branch }}
      enabled-branches: ${{ steps.load.outputs.enabled-branches }}
      java-version: ${{ steps.load.outputs.java-version }}
      runner: ${{ steps.load.outputs.runner }}
      gradle-flags: ${{ steps.load.outputs.gradle-flags }}
      kotlin-native-cache: ${{ steps.load.outputs.kotlin-native-cache }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Load project configuration
        id: load
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Get current branch name
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.base_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          # Check if CI is enabled for this branch
          ENABLED_BRANCHES=$(yq '.ci.enabled_branches' project.yml)
          
          if [[ "$ENABLED_BRANCHES" == "false" ]]; then
            CI_ENABLED="false"
          elif [[ "$ENABLED_BRANCHES" == "all" ]]; then
            CI_ENABLED="true"
          else
            # Check if current branch is in the list
            if echo "$ENABLED_BRANCHES" | yq ".[] | select(. == \"$BRANCH\")" | grep -q "$BRANCH"; then
              CI_ENABLED="true"
            else
              CI_ENABLED="false"
            fi
          fi
          
          echo "ci-enabled=$CI_ENABLED" >> $GITHUB_OUTPUT
          echo "current-branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "enabled-branches=$ENABLED_BRANCHES" >> $GITHUB_OUTPUT
          echo "java-version=$(yq '.versions.java' project.yml)" >> $GITHUB_OUTPUT
          echo "runner=$(yq '.ci.runners.primary' project.yml)" >> $GITHUB_OUTPUT
          echo "gradle-flags=$(yq '.ci.gradle_flags | join(" ")' project.yml)" >> $GITHUB_OUTPUT
          echo "kotlin-native-cache=$(yq '.ci.caching.kotlin_native' project.yml)" >> $GITHUB_OUTPUT
      
      - name: CI Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ CI Configuration Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Current branch:    ${{ steps.load.outputs.current-branch }}"
          echo "Enabled branches:  ${{ steps.load.outputs.enabled-branches }}"
          echo "CI enabled:        ${{ steps.load.outputs.ci-enabled }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ steps.load.outputs.ci-enabled }}" == "false" ]]; then
            echo "â­ï¸  Build job will be SKIPPED (CI disabled for this branch)"
            echo ""
            echo "To enable CI for this branch, update project.yml:"
            echo "  ci:"
            echo "    enabled_branches: [${{ steps.load.outputs.current-branch }}]"
          else
            echo "âœ… Build job will RUN"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  
  build:
    needs: config
    if: needs.config.outputs.ci-enabled == 'true'
    runs-on: ${{ needs.config.outputs.runner }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ needs.config.outputs.java-version }}
      
      - name: Cache Kotlin/Native dependencies
        if: needs.config.outputs.kotlin-native-cache == 'true'
        uses: actions/cache@v5
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-
          
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
          
      - name: Build and Test
        run: ./gradlew build ${{ needs.config.outputs.gradle-flags }} --stacktrace
