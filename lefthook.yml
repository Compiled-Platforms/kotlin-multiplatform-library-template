# Lefthook configuration for Git hooks
# Install: brew install lefthook (macOS) or see https://github.com/evilmartians/lefthook
# Setup: lefthook install

pre-commit:
  parallel: true
  commands:
    detekt:
      glob: "*.{kt,kts}"
      run: ./gradlew detekt --daemon
      stage_fixed: true
    
    check-secrets:
      glob: "*.{properties,yml,yaml,json}"
      run: |
        # Check for actual hardcoded secrets (not GitHub Actions template syntax). POSIX sh for CI.
        for file in {staged_files}; do
          case "$file" in
            .github/workflows/*|lefthook.yml) continue ;;
          esac
          if grep -i "password\|secret\|token\|key" "$file" | grep -iv "secrets\." | grep -v "SIGNING_KEY\|MAVEN_CENTRAL\|github_token" | grep -qE ":\s*['\"]?[a-zA-Z0-9]{20,}"; then
            echo "âŒ Potential hardcoded secret found in $file"
            exit 1
          fi
        done

commit-msg:
  commands:
    commitlint:
      run: npx commitlint --edit {1} --config .commitlintrc.json

pre-push:
  commands:
    test:
      # Pass max-concurrency from project.yml (scripts.test_platforms.max_concurrency); fallback 3
      run: python3 scripts/test_platforms.py --max-concurrency $(python3 scripts/get-config.py scripts.test_platforms.max_concurrency 2>/dev/null || echo 3)

skip_output:
  - meta
  - success
